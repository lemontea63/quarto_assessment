---
title: "Quarto Assessment MT24"
format: html: embed-resources: true
editor: source
---

#Introduction
This analysis aims to assess the impact of drought on beak morphology in the medium ground finch (Geospiza fortis), found in the Galapagos islands. Beak morphology is intricately linked to food availability, with beaks adapting to certain sets of food sources which are available within the niche of a certain species. Freak events like droughts or floods create large selection pressures which act on beak morphology as they impact food availability; these sorts of events may prevent many plant species which are not tolerant to stresses from setting seed, or some plants may even die which will limit food availability in a particular year. To overcome these selection pressures, animals such as birds will evolve to become better adapted to the changed environment, for example by evolving larger, tougher beaks which can take advantage of remaining food sources.

```{r}
#Loading packages needed for this analysis.
library(Sleuth3) 
library(ggplot2) 
library(tinytex) 
library(arm) 
library(rmarkdown)
library(here)
library(renv)
library(dplyr)
library(multcompView)
library(ragg)
```
```{r}
#Investigating data.
head(case0201)
str(case0201)
summary(case0201)
colnames(case0201)

#Preserving raw data as .csv file to keep it safe in event of mutation.
write.csv(case0201, here("data/finches_raw.csv"))
finches_raw <- read.csv(here("data/finches_raw.csv"))

#Factorising "Year" variable.
finches_raw$Year = as.factor(finches_raw$Year)
str(finches_raw)

#Histograms to check spread of data- transformations unsuccessful so will simply use untransformed data.
ggplot(data = finches_raw, aes(x = Depth)) + geom_histogram()
log_depth <- log10(finches_raw$Depth)
ggplot(data = finches_raw, aes(x = log_depth)) + geom_histogram()
sqrt_depth <- sqrt(finches_raw$Depth)
ggplot(data = finches_raw, aes(x = sqrt_depth)) + geom_histogram()

#Setting own colours for each year.
year_colours <- c("1976" = "magenta2", "1978" = "darkorange")
         
#Plotting exploratory boxplot to see what data look like.
finches_exploratory_figure <- ggplot(data = finches_raw, aes(x=Year, y=Depth, group = Year)) + geom_boxplot(aes(color = Year)) + geom_jitter(aes(color = Year), alpha = 0.3, position = position_jitter(width = 0.2, seed=0)) + labs (x= "Year", y = "Beak depth (mm)") + scale_colour_manual(values = year_colours)
finches_exploratory_figure

#Saving exploratory figure to figures folder.
agg_png("figures/finches_exploratory_figure.png", 
        width = 25,
        height = 15,
        units = "cm",
        res = 300,
        scaling = 1.125)

print(finches_exploratory_figure)
dev.off()
```
#Methods
To analyse the effect of year on beak depth (mm), a one-way ANOVA test will be conducted. This is because there are two distinct populations, and there is a continuous response variable and a categorical explanatory variable. 

The null hypothesis is that the difference in mean beak depth between years is equal to 0.

The alternative hypothesis is that the mean difference in beak depth between years is not equal to 0.

```{r Statistical analysis using lm function}

#Creating linear model to be used for analysing how year affects beak depth.
finches_model <- lm(Depth ~ Year, data = finches_raw)

#Creating plots to ensure assumptions of test are not violated.
plot(finches_model, which=2)
plot(finches_model, which=1)

summary(finches_model)

#Conducting ANOVA on model to establish if there is a significant effect of year on beak depth. Produces anova table.
finch_anova <- aov(finches_model)
summary(finch_anova)

#Conducting Tukey test to ascertain which groups are different (this is already known but necessary for subsequent code). This produces a Tukey post-hoc multiple comparisons table.
finch_tukey <- TukeyHSD(finch_anova)
print(finch_tukey)

#Creates compact letter display, useful for graphically representing significant differences between groups.
finch_cld <- multcompLetters4(finch_anova, finch_tukey)
print(finch_cld)

#Creating new table containing information on mean beak depth in each year, the 3rd quantile of each group and what compact letter each group belongs to.
finch_analysed <- group_by(finches_raw, Year) %>% 
  summarise(mean = mean(Depth), quant = quantile(Depth, probs = 0.75)) %>% 
  arrange(desc(mean))

finch_cld <- as.data.frame.list(finch_cld$Year)
finch_analysed$cld <- finch_cld$Letters

print(finch_analysed)

means <- aggregate(Depth ~ Year, finches_raw, mean)
```

#Results
This one-way ANOVA analysis shows there is a statistically significant difference in mean beak depth between 1976 and 1978.
In 1976, mean beak depth was 9.470mm but in 1978 the mean increased to 10.138mm.

From the summary table for the finch_model, it can be seen that only 10.16% of variation in beak depth is explained by year (adjusted R-squared = 0.1016). This is surprising as it was expected that the year would play a large role in explaining variation in beak depth, and suggests there may be other factors influencing this. 
That said, the F-value for the ANOVA is 21, which is greater than 1 and therefore shows a significant difference between mean beak depth in 1976 and in 1978. The p-value for this analysis was 8.65*10^-6. 

The Tukey analysis showed the mean value of beak depth (mm) differed between 1976 and 1978 by 0.669mm. The p-value is 8.6*10^-6, the 95% CI is 0.381 to 0.956mm difference. As this 95% CI does not include 0, this shows there is a significant difference between groups.

On the boxplot showing the results of this analsis, the median of each group is represented by the bar across the box; the mean of eac group is represented by the dark blue dot.
The significant difference between the mean beak depths in each year is shown on the results boxplot, with the compact letter display showing a difference between years. On the graph, there are two groups, a and b, which correspond to 1976 (b) and 1978 (a).
This means the null hypothesis that there is no difference in mean beak depth between years can be rejected. 


```{r}

#Plotting results figure incorporating compacct letter display gained from analysis.
finches_results_figure <- ggplot(data = finches_raw, aes(x=Year, y=Depth, group = Year)) + geom_boxplot(aes(color = Year)) + geom_jitter(aes(color = Year), alpha = 0.3, position = position_jitter(width = 0.2, seed=0)) + labs (x= "Year", y = "Beak depth (mm)") + scale_colour_manual(values = year_colours) + stat_summary(fun=mean, colour = "darkblue", geom = "pointrange", shape = 16, size = 0.3, show.legend = FALSE) + geom_text(data = finch_analysed, aes(x=Year, y= quant, label = cld), size = 5, vjust = -1, hjust = -6)
finches_results_figure

#Saving results figure in figures folder.
agg_png("figures/finches_results_figure.png", 
        width = 25,
        height = 15,
        units = "cm",
        res = 300,
        scaling = 1.125)
print(finches_results_figure)
dev.off()

```
#Conclusion
In conclusion, it has been shown that there is a difference in the mean beak depth of the medium ground finch between 1976 and 1978, and therefore that drougt can cause beak morphology to evolve in G. fortis. 